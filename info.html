import os
from flask import Flask, render_template, request, jsonify, session, Response, stream_with_context
from groq import Groq
from dotenv import load_dotenv
from langdetect import detect, DetectorFactory

load_dotenv()

app = Flask(__name__, template_folder='templates')
app.config['SECRET_KEY'] = os.environ.get('flaskseckey', 'dev-secret-key')


api_key = os.environ.get("GROQ_API_KEY")
if not api_key:
    raise ValueError("âŒ Missing GROQ_API_KEY in .env file")

client = Groq(api_key=api_key)

GROQ_MODEL = os.environ.get("GROQ_MODEL", "llama3-8b-8192")
TEMPERATURE = float(os.environ.get("TEMPERATURE", 0.4))

sysprompt = """
You are 'à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤šà¥à¤¨à¤¾à¤µ à¤¸à¤²à¤¾à¤¹à¤•à¤¾à¤°' â€“ a friendly and knowledgeable helper for anything related to Indian elections.

Your role:
- Give clear, step-by-step help for things like:
  â€¢ Voter registration process ðŸ“
  â€¢ Getting or correcting EPIC (Voter ID) cards ðŸ†”
  â€¢ Polling booth information and voting schedule ðŸ“…
  â€¢ How EVM & VVPAT work âš™ï¸
  â€¢ Voter rights and responsibilities âš–ï¸
  â€¢ Rules for contesting elections ðŸ—³ï¸
- Keep explanations simple, practical, and easy for anyone to follow.
- Answer **only** about Indian elections. If someone asks about something else, politely refuse in the same language they used.
- Make answers neat and readable:
  â€¢ Use bold headings
  â€¢ Numbered steps or bullet points
  â€¢ Add emojis where it helps clarity and friendliness
"""

LANGUAGE_CONFIG = {
    'hi': {"instruction": "Language: Reply in Hindi with detailed guidance.", "refusal": "ðŸš« *à¤®à¤¾à¤« à¤•à¤°à¥‡à¤‚, à¤®à¥ˆà¤‚ à¤•à¥‡à¤µà¤² à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤šà¥à¤¨à¤¾à¤µ à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾ à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¦à¥‡ à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤‚à¥¤*"},
    'en': {"instruction": "Language: Reply in English with detailed guidance.", "refusal": "ðŸš« *I can only provide information about Indian election processes.*"},
    'bn': {"instruction": "Language: Reply in Bengali with detailed guidance.", "refusal": "ðŸš« *à¦†à¦®à¦¿ à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦­à¦¾à¦°à¦¤à§€à¦¯à¦¼ à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦ªà§à¦°à¦•à§à¦°à¦¿à¦¯à¦¼à¦¾ à¦¸à¦®à§à¦ªà¦°à§à¦•à§‡ à¦¤à¦¥à§à¦¯ à¦¦à¦¿à¦¤à§‡ à¦ªà¦¾à¦°à¦¿à¥¤*"},
    'mr': {"instruction": "Language: Reply in Marathi with detailed guidance.", "refusal": "ðŸš« *à¤®à¥€ à¤«à¤•à¥à¤¤ à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤¨à¤¿à¤µà¤¡à¤£à¥‚à¤• à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¥‡à¤¬à¤¦à¥à¤¦à¤² à¤®à¤¾à¤¹à¤¿à¤¤à¥€ à¤¦à¥‡à¤Š à¤¶à¤•à¤¤à¥‹.*"},
    'gu': {"instruction": "Language: Reply in Gujarati with detailed guidance.", "refusal": "ðŸš« *àª¹à«àª‚ àª«àª•à«àª¤ àª­àª¾àª°àª¤à«€àª¯ àªšà«‚àª‚àªŸàª£à«€ àªªà«àª°àª•à«àª°àª¿àª¯àª¾ àªµàª¿àª¶à«‡ àª®àª¾àª¹àª¿àª¤à«€ àª†àªªà«€ àª¶àª•à«àª‚ àª›à«àª‚.*"},
    'pa': {"instruction": "Language: Reply in Punjabi with detailed guidance.", "refusal": "ðŸš« *à¨®à©ˆà¨‚ à¨¸à¨¿à¨°à¨«à¨¼ à¨­à¨¾à¨°à¨¤à©€ à¨šà©‹à¨£ à¨ªà©à¨°à¨•à¨¿à¨°à¨¿à¨† à¨¬à¨¾à¨°à©‡ à¨œà¨¾à¨£à¨•à¨¾à¨°à©€ à¨¦à©‡ à¨¸à¨•à¨¦à¨¾ à¨¹à¨¾à¨‚à¥¤*"},
    'ur': {"instruction": "Language: Reply in Urdu (Roman script) with detailed guidance.", "refusal": "ðŸš« *Main sirf Bharatiya election process ke bare mein maloomaat de sakta hun.*"},
    'or': {"instruction": "Language: Reply in Odia with detailed guidance.", "refusal": "ðŸš« *à¬®à­à¬ à¬•à­‡à¬¬à¬³ à¬­à¬¾à¬°à¬¤à­€à­Ÿ à¬¨à¬¿à¬°à­à¬¬à¬¾à¬šà¬¨ à¬ªà­à¬°à¬•à­à¬°à¬¿à­Ÿà¬¾ à¬¬à¬¿à¬·à­Ÿà¬°à­‡ à¬¸à­‚à¬šà¬¨à¬¾ à¬¦à­‡à¬‡à¬ªà¬¾à¬°à­‡à¥¤*"},
    'as': {"instruction": "Language: Reply in Assamese with detailed guidance.", "refusal": "ðŸš« *à¦®à¦‡ à¦•à§‡à§±à¦² à¦­à¦¾à§°à¦¤à§€à¦¯à¦¼ à¦¨à¦¿à§°à§à¦¬à¦¾à¦šà¦¨ à¦ªà§à§°à¦•à§à§°à¦¿à¦¯à¦¼à¦¾à§° à¦¬à¦¿à¦·à¦¯à¦¼à§‡ à¦¤à¦¥à§à¦¯ à¦¦à¦¿à¦¬ à¦ªà¦¾à§°à§‹à¥¤*"},
    'ks': {"instruction": "Language: Reply in Kashmiri (Roman script) with detailed guidance.", "refusal": "ðŸš« *Bi sirf Bharatiya election process baaras jaankaari dith shakaan.*"},
    'kok': {"instruction": "Language: Reply in Konkani with detailed guidance.", "refusal": "ðŸš« *à¤¹à¤¾à¤‚à¤µ à¤«à¤•à¤¤ à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤¨à¤¿à¤µà¤¡à¤£à¥à¤•à¥‡à¤šà¥à¤¯à¤¾ à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¥‡à¤µà¤¿à¤¶à¥€à¤‚ à¤®à¤¾à¤¹à¤¿à¤¤à¥€ à¤¦à¤¿à¤µà¤‚à¤• à¤¶à¤•à¤¤à¤¾à¤‚.*"},
    'ne': {"instruction": "Language: Reply in Nepali with detailed guidance.", "refusal": "ðŸš« *à¤® à¤•à¥‡à¤µà¤² à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤šà¥à¤¨à¤¾à¤µ à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾à¤•à¥‹ à¤¬à¤¾à¤°à¥‡à¤®à¤¾ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¦à¤¿à¤¨ à¤¸à¤•à¥à¤›à¥à¥¤*"},
    'ta': {"instruction": "Language: Reply in Tamil with detailed guidance.", "refusal": "ðŸš« *à®¨à®¾à®©à¯ à®‡à®¨à¯à®¤à®¿à®¯ à®¤à¯‡à®°à¯à®¤à®²à¯ à®šà¯†à®¯à®²à¯à®®à¯à®±à¯ˆà®•à®³à¯ˆà®ªà¯ à®ªà®±à¯à®±à®¿ à®®à®Ÿà¯à®Ÿà¯à®®à¯‡ à®¤à®•à®µà®²à¯ à®…à®³à®¿à®•à¯à®• à®®à¯à®Ÿà®¿à®¯à¯à®®à¯.*"},
    'te': {"instruction": "Language: Reply in Telugu with detailed guidance.", "refusal": "ðŸš« *à°¨à±‡à°¨à± à°­à°¾à°°à°¤à±€à°¯ à°Žà°¨à±à°¨à°¿à°•à°² à°ªà±à°°à°•à±à°°à°¿à°¯à°² à°—à±à°°à°¿à°‚à°šà°¿ à°®à°¾à°¤à±à°°à°®à±‡ à°¸à°®à°¾à°šà°¾à°°à°‚ à°…à°‚à°¦à°¿à°‚à°šà°—à°²à°¨à±.*"},
    'kn': {"instruction": "Language: Reply in Kannada with detailed guidance.", "refusal": "ðŸš« *à²¨à²¾à²¨à³ à²­à²¾à²°à²¤à³€à²¯ à²šà³à²¨à²¾à²µà²£à²¾ à²ªà³à²°à²•à³à²°à²¿à²¯à³†à²—à²³ à²¬à²—à³à²—à³† à²®à²¾à²¤à³à²° à²®à²¾à²¹à²¿à²¤à²¿ à²¨à³€à²¡à²¬à²²à³à²²à³†.*"},
    'ml': {"instruction": "Language: Reply in Malayalam with detailed guidance.", "refusal": "ðŸš« *à´Žà´¨à´¿à´•àµà´•àµ à´‡à´¨àµà´¤àµà´¯àµ» à´¤à´¿à´°à´žàµà´žàµ†à´Ÿàµà´ªàµà´ªàµ à´ªàµà´°à´•àµà´°à´¿à´¯à´•à´³àµ† à´•àµà´±à´¿à´šàµà´šàµ à´®à´¾à´¤àµà´°à´®àµ‡ à´µà´¿à´µà´°à´™àµà´™àµ¾ à´¨àµ½à´•à´¾àµ» à´•à´´à´¿à´¯àµ‚.*"},
}

def get_system_prompt(lang_code: str) -> str:
    """Merge the base prompt with the language-specific instructions."""
    config = LANGUAGE_CONFIG.get(lang_code, LANGUAGE_CONFIG['hi'])
    return f"{sysprompt.strip()}\n{config['instruction']}"

@app.route('/')
def home():
    session.pop('chat_history', None) 
    return render_template('index.html')

@app.route('/feedback', methods=['POST'])
def feedback():
    """Receive user feedback (not stored permanently in this version)."""
    try:
        data = request.json or {}
        app.logger.info(f"Feedback: {data}")
        return jsonify({'status': 'success', 'message': 'Feedback received'})
    except Exception as e:
        app.logger.error(f"Feedback error: {e}")
        return jsonify({'error': 'Could not process feedback'}), 500

DetectorFactory.seed = 0 

@app.route('/chat', methods=['POST'])
def chat():
    """Main chat endpoint with language detection and Groq streaming."""
    user_message = request.json.get("message", "").strip()
    frontend_lang = request.json.get("language", "").lower()

    if not user_message:
        return jsonify({"error": "No message provided"}), 400

    try:
        detected_lang = detect(user_message)
    except:
        detected_lang = 'hi'

    lang_code = (frontend_lang or detected_lang or 'hi').lower()
    if lang_code not in LANGUAGE_CONFIG:
        lang_code = 'hi'

    chat_history = session.get("chat_history", [])
    messages_for_api = [
        {"role": "system", "content": get_system_prompt(lang_code)},
        *chat_history,
        {"role": "user", "content": user_message}
    ]

    def generate_chunks():
        full_response = ""
        try:
            stream = client.chat.completions.create(
                messages=messages_for_api,
                model=GROQ_MODEL,
                temperature=TEMPERATURE,
                stream=True,
                max_tokens=2048
            )
            for chunk in stream:
                token = chunk.choices[0].delta.content
                if token:
                    full_response += token
                    yield token

        
            chat_history.extend([
                {"role": "user", "content": user_message},
                {"role": "assistant", "content": full_response}
            ])
            session["chat_history"] = chat_history[-10:]
        except Exception as e:
            app.logger.error(f"Groq API error: {e}")
            yield "\n[Error: Could not process your request]"

    return Response(stream_with_context(generate_chunks()), mimetype="text/plain")

@app.route('/reset', methods=['POST'])
def reset_chat():
    """Clear chat history."""
    session.pop('chat_history', None)
    return jsonify({'status': 'success', 'message': 'Chat history cleared.'})


if __name__ == '__main__':
    currentenv = os.environ.get('flaskenv', '').lower()
    production_mode = (currentenv == 'production')
    app.run(
        debug=not production_mode,
        port=5001
    )
